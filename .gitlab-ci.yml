test-ops:
  image: mcr.microsoft.com/playwright:v1.51.0-noble
  tags:
    - k8s-dev
  cache:
    key: '$CI_COMMIT_REF_SLUG'
    paths:
      - node_modules/
  variables:
    ALLURE_ENDPOINT: 'https://teoriiotpraktikov.qatools.cloud/'
    ALLURE_PROJECT_ID: '1'
    ALLURE_RESULTS: '/builds/qa/cloud-playwright/src/report/allure-results'
    BOT_TOKEN: '7779869356:AAECe0sdrLq0e_EajRHVhgEvu2bGaUdtEv8'
    CHAT_ID: '-1002691846651'
    ALLURE_LAUNCH_TAGS: 'medium, smoke'
  before_script:
    - apt update
    - apt install -y jq
    - npm install -g pnpm@latest
    - pnpm install
    - curl -fsSL https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64 -o allurectl
    - chmod +x allurectl
  script:
    - eval $(./allurectl job-run env)
    - ./allurectl watch -- pnpm run test:smoke || true
    - ls -la
    - |
      filePath="./src/report/allure-resultstest-results.json"
      if [ -f "$filePath" ]; then
        PASSED=$(jq '.stats.expected // 0' $filePath)
        FAILED=$(jq '.stats.unexpected // 0' $filePath)
        SKIPPED=$(jq '.stats.skipped // 0' $filePath)
        FLAKY=$(jq '.stats.flaky // 0' $filePath)
        TOTAL=$((PASSED + FAILED + SKIPPED + FLAKY))
        export PASSED=$PASSED
        export FAILED=$FAILED
        export SKIPPED=$SKIPPED
        export FLAKY=$FLAKY
        export TOTAL=$TOTAL
      else
        echo "Allure results file not found: $filePath"
        exit 1
      fi
    - |
      MESSAGE="üß™ –û—Ç—á–µ—Ç –ø–æ —Ç–µ—Å—Ç–∞–º:
      - üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${COMPANY_NAME:-$CI_PROJECT_NAME}
      - üåø –í–µ—Ç–∫–∞: ${BRANCH:-$CI_COMMIT_REF_NAME}
      - üìù –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞: ${COMMIT_MESSAGE:-$CI_COMMIT_MESSAGE}
      - üîë Short hash: ${COMMIT:-$CI_COMMIT_SHORT_SHA}

      üîó –°—Å—ã–ª–∫–∏:
      - üßü‚Äç‚ôÇÔ∏è –ü–æ—Ä—Ç–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $KAMPUS_USER_BASE_URL
      - üßë‚Äçüíº –ü–æ—Ä—Ç–∞–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: $KAMPUS_ADMIN_BASE_URL
      - üìä Allure TestOps: $ALLURE_LAUNCH_URL

      –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
      - üìå –í—Å–µ–≥–æ: $TOTAL
      - ‚úÖ –ü—Ä–æ–π–¥–µ–Ω–æ: $PASSED
      - ‚ùå –ù–µ—É–¥–∞—á–Ω–æ: $FAILED
      - ‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: $SKIPPED
      - ü§¨ –§–ª–∞–∫–∏: $FLAKY"
      curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" -d "chat_id=${CHAT_ID}" -d "text=${MESSAGE}"
  artifacts:
    paths:
      - $ALLURE_RESULTS/
      - test-results/
    when: always
  allow_failure: true
